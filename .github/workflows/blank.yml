import requests
import time
import threading
import sys
import json
import os
import glob
import string
import random
from datetime import datetime
from flask import Flask, render_template_string, request, jsonify

app = Flask(__name__) #hehehehe

CONFIG_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "configs")
if not os.path.exists(CONFIG_DIR):
    os.makedirs(CONFIG_DIR)

BASE = "https://altare.sh"

# ==========================================
# QU·∫¢N L√ù TR·∫†NG TH√ÅI (STATE)
# ==========================================
app_state = {
    "sessions": {},
    "logs": {}
}

def init_client_state(client_id):
    if client_id not in app_state["sessions"]:
        app_state["sessions"][client_id] = {}
    if client_id not in app_state["logs"]:
        app_state["logs"][client_id] = []

def get_config_path(client_id):
    clean_id = "".join(c for c in client_id if c.isalnum() or c in ('_', '-'))
    return os.path.join(CONFIG_DIR, f"{clean_id}.json")

def load_config(client_id):
    config = {"accounts": [], "heartbeat_interval": 30, "stats_interval": 60}
    path = get_config_path(client_id)
    if os.path.exists(path):
        try:
            with open(path, "r", encoding="utf-8") as f:
                loaded = json.load(f)
                config.update(loaded)
        except Exception:
            pass
    return config

def save_config(client_id, config):
    path = get_config_path(client_id)
    with open(path, "w", encoding="utf-8") as f:
        json.dump(config, f, indent=4)

def add_log(client_id, msg, ident="SYSTEM"):
    init_client_state(client_id)
    ts = datetime.now().strftime("%H:%M:%S")
    short_ident = ident.split('@')[0] if '@' in ident else ident[:10]
    log_str = f"[{ts}] [{short_ident}] {msg}"
    print(f"[{client_id[:8]}] {log_str}")
    
    app_state["logs"][client_id].append(log_str)
    if len(app_state["logs"][client_id]) > 100:
        app_state["logs"][client_id].pop(0)

def make_headers(token, tenant_id=""):
    h = {
        "Authorization": token,
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Origin": "https://altare.sh",
        "Referer": "https://altare.sh/",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36"
    }
    if tenant_id:
        h["altare-selected-tenant-id"] = tenant_id
    return h

def generate_random_handle():
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))

# ==========================================
# GIAO TI·∫æP API ALTARE
# ==========================================

def start_afk_session(client_id, headers, tenant_id, ident):
    try:
        r = requests.post(f"{BASE}/api/tenants/{tenant_id}/rewards/afk/start", headers=headers, json={}, timeout=10)
        if r.status_code in (200, 201, 204):
            add_log(client_id, "‚ñ∂ K√≠ch ho·∫°t AFK th√†nh c√¥ng", ident)
            return True
        else:
            add_log(client_id, f"L·ªói k√≠ch ho·∫°t AFK: {r.status_code}", ident)
    except Exception as e:
        add_log(client_id, f"Ngo·∫°i l·ªá khi start AFK: {e}", ident)
    return False

def stop_afk_session(client_id, headers, tenant_id, ident):
    try:
        r = requests.post(f"{BASE}/api/tenants/{tenant_id}/rewards/afk/stop", headers=headers, json={}, timeout=10)
        add_log(client_id, f"‚è∏ ƒê√£ D·ª´ng AFK ({r.status_code})", ident)
    except Exception as e:
        add_log(client_id, f"L·ªói khi Stop AFK: {e}", ident)

def send_heartbeat(headers, tenant_id):
    try:
        r = requests.post(f"{BASE}/api/tenants/{tenant_id}/rewards/afk/heartbeat", headers=headers, json={}, timeout=10)
        return r.status_code in (200, 201, 204)
    except:
        return False

def do_auto_transfer(client_id, acc, headers, tenant_id, target_handle):
    ident = acc["identifier"]
    add_log(client_id, f"‚ö° ƒêang thi·∫øt l·∫≠p v√≠ ƒë·ªÉ chuy·ªÉn ƒë·ªïi...", ident)
    
    # 1. Random Handle & B·∫≠t Payments
    patch_url = f"{BASE}/api/tenants/{tenant_id}/wallet/settings"
    rand_handle = generate_random_handle()
    payload_patch = {"paymentsEnabled": True, "handle": rand_handle}
    
    try:
        r_patch = requests.patch(patch_url, headers=headers, json=payload_patch, timeout=10)
        if r_patch.status_code == 200 and r_patch.json().get("ok"):
            add_log(client_id, f"‚úì Setup v√≠ th√†nh c√¥ng (Handle: {rand_handle})", ident)
            
            # 2. L·∫•y s·ªë d∆∞ ch√≠nh x√°c
            r_bal = requests.get(f"{BASE}/api/tenants", headers=headers, timeout=10)
            exact_cents = 0
            if r_bal.status_code == 200:
                for item in r_bal.json().get("items", []):
                    if item.get("id") == tenant_id:
                        exact_cents = item.get("creditsCents", 0)
                        break
            
            # --- X·ª¨ L√ù L√ÄM TR√íN S·ªê CH·∫¥N ---
            integer_credits = exact_cents // 100
            transfer_cents = integer_credits * 100
                        
            if transfer_cents > 0:
                # 3. Th·ª±c hi·ªán Transfer
                post_url = f"{BASE}/api/tenants/{tenant_id}/wallet/transfer"
                payload_post = {"to": target_handle, "amountCents": transfer_cents}
                
                add_log(client_id, f"üí∏ ƒêang chuy·ªÉn {integer_credits} cr (ch·ªâ l·∫•y ph·∫ßn nguy√™n) ƒë·∫øn '{target_handle}'...", ident)
                r_post = requests.post(post_url, headers=headers, json=payload_post, timeout=10)
                
                if r_post.status_code == 200 and r_post.json().get("ok"):
                    add_log(client_id, f"üéâ CHUY·ªÇN TH√ÄNH C√îNG {integer_credits} cr!", ident)
                    return True
                else:
                    add_log(client_id, f"‚ùå L·ªói chuy·ªÉn cr: {r_post.text}", ident)
            else:
                add_log(client_id, f"‚ö†Ô∏è S·ªë d∆∞ ch·∫µn = 0 (hi·ªán c√≥ {exact_cents/100:.2f}), ch∆∞a ƒë·ªß 1 cr ƒë·ªÉ chuy·ªÉn.", ident)
        else:
            add_log(client_id, f"‚ùå L·ªói setup v√≠: {r_patch.text}", ident)
    except Exception as e:
        add_log(client_id, f"‚ùå Ngo·∫°i l·ªá Transfer: {e}", ident)
        
    return False

# ==========================================
# LU·ªíNG X·ª¨ L√ù (THREADS)
# ==========================================

def sse_loop(client_id, acc):
    token = acc["token"]
    ident = acc["identifier"]
    tenant_id = acc["tenant_id"]
    raw = token.replace("Bearer ", "")
    url = f"https://api.altare.sh/subscribe?token={raw}"
    sse_headers = make_headers(token)
    sse_headers["Accept"] = "text/event-stream"
    sse_headers["Cache-Control"] = "no-cache"
    
    first_connect = True
    while app_state["sessions"].get(client_id, {}).get(tenant_id, {}).get("running", False):
        if not app_state["sessions"][client_id][tenant_id].get("is_farming", False):
            first_connect = True
            time.sleep(3)
            continue
        try:
            with requests.get(url, headers=sse_headers, stream=True, timeout=(10, None)) as r:
                if r.status_code == 200:
                    if first_connect:
                        add_log(client_id, "K·∫øt n·ªëi SSE ·ªïn ƒë·ªãnh ‚úì", ident)
                        first_connect = False
                    for line in r.iter_lines(chunk_size=1):
                        if not app_state["sessions"].get(client_id, {}).get(tenant_id, {}).get("running", False) or \
                           not app_state["sessions"][client_id][tenant_id].get("is_farming", False):
                            break
                else:
                    first_connect = True
                    time.sleep(10)
        except:
            first_connect = True
            time.sleep(10)
        time.sleep(3)

def heartbeat_loop(client_id, cfg, acc):
    interval = cfg.get("heartbeat_interval", 30)
    headers = make_headers(acc["token"], acc["tenant_id"])
    tenant_id = acc["tenant_id"]
    while app_state["sessions"].get(client_id, {}).get(tenant_id, {}).get("running", False):
        if app_state["sessions"][client_id][tenant_id].get("is_farming", False):
            send_heartbeat(headers, tenant_id)
        time.sleep(interval)

def stats_loop(client_id, cfg, acc):
    interval = cfg.get("stats_interval", 60)
    headers = make_headers(acc["token"], acc["tenant_id"])
    tenant_id = acc["tenant_id"]
    ident = acc["identifier"]
    
    credits_start = 0
    stuck_count = 0
    last_balance = None
    
    while app_state["sessions"].get(client_id, {}).get(tenant_id, {}).get("running", False):
        if not app_state["sessions"][client_id][tenant_id].get("is_farming", False):
            time.sleep(5)
            continue
            
        try:
            r = requests.get(f"{BASE}/api/tenants", headers=headers, timeout=10)
            if r.status_code == 200:
                items = r.json().get("items", [])
                for item in items:
                    if item.get("id") == tenant_id:
                        cents = item.get("creditsCents")
                        if cents is not None:
                            bal = round(cents / 100, 2)
                            app_state["sessions"][client_id][tenant_id]["balance"] = bal
                            
                            if not credits_start:
                                credits_start = bal
                            earned = round(bal - credits_start, 4)
                            add_log(client_id, f"üí∞ Balance: {bal:.4f} cr | Earned: +{earned:.4f} cr", ident)
                            
                            # X·ª≠ l√Ω AUTO TRANSFER
                            auto_tx = app_state["sessions"][client_id][tenant_id].get("auto_transfer", {})
                            if auto_tx.get("enabled") and bal >= auto_tx.get("threshold", 999999):
                                add_log(client_id, f"üîî Balance ƒë·∫°t m·ªëc {bal} >= {auto_tx.get('threshold')}", ident)
                                success = do_auto_transfer(client_id, acc, headers, tenant_id, auto_tx.get("target"))
                                if success:
                                    credits_start = 0
                                    last_balance = None
                                    time.sleep(5)
                                    continue 

                            # Anti-k·∫πt
                            if last_balance is not None and bal == last_balance:
                                stuck_count += 1
                                if stuck_count >= 3:
                                    add_log(client_id, f"‚ö†Ô∏è Balance k·∫πt {stuck_count} l·∫ßn. T·ª± Reset AFK...", ident)
                                    stop_afk_session(client_id, headers, tenant_id, ident)
                                    time.sleep(3)
                                    start_afk_session(client_id, headers, tenant_id, ident)
                                    stuck_count = 0
                            else:
                                stuck_count = 0
                                last_balance = bal
        except:
            pass
            
        time.sleep(interval)

def start_account_threads(client_id, cfg, acc):
    init_client_state(client_id)
    tenant_id = acc["tenant_id"]
    headers = make_headers(acc["token"], tenant_id)
    
    # ƒê·ªåC C·∫§U H√åNH AUTO-TRANSFER T·ª™ FILE KHI KH·ªûI ƒê·ªòNG
    saved_auto_tx = acc.get("auto_transfer", {"enabled": False, "threshold": 0, "target": ""})
    
    app_state["sessions"][client_id][tenant_id] = {
        "running": True, 
        "is_farming": True,
        "balance": 0.0,
        "auto_transfer": saved_auto_tx
    }
    
    start_afk_session(client_id, headers, tenant_id, acc["identifier"])
    
    threading.Thread(target=sse_loop, args=(client_id, acc), daemon=True).start()
    threading.Thread(target=heartbeat_loop, args=(client_id, cfg, acc), daemon=True).start()
    threading.Thread(target=stats_loop, args=(client_id, cfg, acc), daemon=True).start()

def stop_account_threads(client_id, acc, remove_completely=False):
    tenant_id = acc["tenant_id"]
    if tenant_id in app_state["sessions"].get(client_id, {}):
        app_state["sessions"][client_id][tenant_id]["is_farming"] = False
        headers = make_headers(acc["token"], tenant_id)
        stop_afk_session(client_id, headers, tenant_id, acc["identifier"])
        
        if remove_completely:
            app_state["sessions"][client_id][tenant_id]["running"] = False
            add_log(client_id, "ƒê√£ X√≥a t√†i kho·∫£n kh·ªèi h·ªá th·ªëng.", acc["identifier"])

# ==========================================
# FLASK ROUTES & GIAO DI·ªÜN (HTML)
# ==========================================

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Altare Auto Farmer v6.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
            min-height: 100vh;
            color: #0f172a;
        }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }
        .glass-blue {
            background: rgba(240, 249, 255, 0.85);
            backdrop-filter: blur(16px);
            border: 2px solid #bae6fd;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(14, 165, 233, 0.15);
        }
        .console-box {
            background: rgba(15, 23, 42, 0.85);
            color: #38bdf8;
            font-family: 'Courier New', Courier, monospace;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(56, 189, 248, 0.5); border-radius: 10px; }
        input[type="checkbox"] { accent-color: #0ea5e9; width: 1.1rem; height: 1.1rem; cursor: pointer; }
    </style>
</head>
<body class="p-4 md:p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        <div class="glass p-5 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-sky-600">Altare Web Farmer <span class="text-sm font-semibold bg-sky-100 px-2 py-0.5 rounded-full text-sky-700">v6.1 PRO</span></h1>
                <p class="text-sm text-slate-500 font-medium">Auto Farm ‚Ä¢ Anti-AFK ‚Ä¢ Smart Transfer (L∆∞u tr·∫°ng th√°i)</p>
            </div>
            <div class="text-right flex items-center gap-4">
                <div class="text-xs text-right">
                    <div id="clientDisplay" class="font-mono text-slate-500 mb-1">Thi·∫øt b·ªã: ƒêang t·∫£i...</div>
                    <div id="browserCheck" class="text-emerald-600 font-medium">‚úì Tr√¨nh duy·ªát h·ª£p l·ªá</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <div class="glass p-5 h-fit xl:col-span-1">
                <h2 class="text-base font-bold text-slate-700 mb-4 flex justify-between items-center">
                    Th√™m T√†i Kho·∫£n
                    <span id="accCount" class="text-xs bg-sky-100 text-sky-600 px-2 py-1 rounded-full font-bold">0/4</span>
                </h2>
                <form id="addForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Email / Username</label>
                        <input type="text" id="identifier" required class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-400 bg-white/70" placeholder="user@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1">Password</label>
                        <input type="password" id="password" required class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-400 bg-white/70" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" id="addBtn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 rounded-lg transition-colors shadow-md">
                        B·∫Øt ƒê·∫ßu Farm
                    </button>
                </form>
                <div id="addMsg" class="mt-3 text-sm text-center hidden"></div>
            </div>

            <div class="glass p-5 xl:col-span-2">
                <h2 class="text-base font-bold text-slate-700 mb-4">Danh S√°ch T√†i Kho·∫£n</h2>
                <div id="accList" class="space-y-3 max-h-[400px] overflow-y-auto pr-1"></div>
            </div>

            <div class="glass-blue p-5 h-fit xl:col-span-1 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-sky-400 rounded-full opacity-10 blur-xl"></div>
                
                <h2 class="text-base font-bold text-sky-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                    Chuy·ªÉn Credit T·ª± ƒê·ªông
                </h2>
                
                <div class="space-y-4">
                    <div class="bg-white/60 p-3 rounded-xl border border-sky-100 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-sky-900">Ch·ªçn T√†i Kho·∫£n:</span>
                            <label class="text-xs text-sky-600 font-medium flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" id="selectAllTx" onchange="toggleSelectAll(this)"> T·∫•t c·∫£
                            </label>
                        </div>
                        <div id="txAccList" class="space-y-2 max-h-24 overflow-y-auto"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-sky-900 mb-1">Chuy·ªÉn khi Balance ƒë·∫°t (cr)</label>
                        <input type="number" step="0.01" id="txThreshold" class="w-full px-3 py-2 rounded-lg border border-sky-200 focus:ring-2 focus:ring-sky-400 bg-white/80" placeholder="VD: 299.70">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-sky-900 mb-1">Handle ng∆∞·ªùi nh·∫≠n</label>
                        <input type="text" id="txTarget" class="w-full px-3 py-2 rounded-lg border border-sky-200 focus:ring-2 focus:ring-sky-400 bg-white/80" placeholder="VD: standard">
                    </div>

                    <div class="flex gap-2 pt-1">
                        <button onclick="applyAutoTransfer(true)" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 rounded-lg shadow-md transition">B·∫≠t Auto</button>
                        <button onclick="applyAutoTransfer(false)" class="flex-1 bg-slate-400 hover:bg-slate-500 text-white font-semibold py-2 rounded-lg shadow-md transition">T·∫Øt Auto</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="console-box p-4 h-64 relative">
            <div class="flex justify-between items-center mb-2 border-b border-white/10 pb-2">
                <span class="text-sky-400 font-bold text-sm tracking-wider">TERMINAL LOGS</span>
                <button onclick="clearLogs()" class="text-xs text-slate-300 hover:text-white bg-slate-700 hover:bg-red-500 px-3 py-1 rounded transition-colors font-medium">üóë X√≥a Log</button>
            </div>
            <div id="consoleLog" class="overflow-y-auto h-[190px] text-sm space-y-1">
                <div>[H·ªá Th·ªëng] ƒêang t·∫£i log...</div>
            </div>
        </div>
    </div>

    <script>
        const MAX_ACCOUNTS = 4;
        let isProxy = false;
        
        function getClientId() {
            let cid = localStorage.getItem('altare_client_id');
            if (!cid) {
                cid = 'client_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('altare_client_id', cid);
            }
            return cid;
        }
        const CLIENT_ID = getClientId();
        document.getElementById('clientDisplay').innerText = `Thi·∫øt b·ªã: ${CLIENT_ID}`;

        // PH·ª§C H·ªíI TEXT ƒê√É G√ï TR∆Ø·ªöC ƒê√ì CHO √î AUTO TRANSFER
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('txThreshold').value = localStorage.getItem('altare_tx_threshold') || '';
            document.getElementById('txTarget').value = localStorage.getItem('altare_tx_target') || '';
        });

        async function runChecks() {
            if (navigator.webdriver || window._phantom || window.callPhantom) {
                document.getElementById('browserCheck').innerHTML = '‚ö†Ô∏è Ph√°t hi·ªán Bot/Proxy!';
                document.getElementById('browserCheck').className = 'text-xs text-red-600 mt-1 font-bold';
                isProxy = true;
            }
        }

        async function fetchState() {
            try {
                const res = await fetch(`/api/state?client_id=${CLIENT_ID}`);
                const data = await res.json();
                
                const accList = document.getElementById('accList');
                const txAccList = document.getElementById('txAccList');
                
                const checkedTxIds = Array.from(document.querySelectorAll('.tx-check')).filter(cb => cb.checked).map(cb => cb.value);
                
                accList.innerHTML = '';
                txAccList.innerHTML = '';
                
                document.getElementById('accCount').innerText = `${data.accounts.length}/${MAX_ACCOUNTS}`;
                document.getElementById('addBtn').disabled = data.accounts.length >= MAX_ACCOUNTS || isProxy;
                
                if(data.accounts.length === 0) {
                    accList.innerHTML = '<div class="text-center text-slate-400 py-6 italic">Ch∆∞a c√≥ t√†i kho·∫£n n√†o.</div>';
                    txAccList.innerHTML = '<div class="text-xs text-slate-400 italic">Ch∆∞a c√≥ t√†i kho·∫£n.</div>';
                }

                data.accounts.forEach(acc => {
                    const session = data.sessions[acc.tenant_id] || {};
                    const isFarming = session.is_farming;
                    const balanceText = session.balance !== undefined ? `${session.balance.toFixed(4)} cr` : "ƒêang t·∫£i...";
                    
                    const autoTx = session.auto_transfer || {};
                    const autoTxBadge = autoTx.enabled 
                        ? `<span class="ml-2 text-[10px] font-bold bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded shadow-sm border border-emerald-200">üîÑ T·ªõi ${autoTx.threshold} ‚ûù ${autoTx.target}</span>` 
                        : '';

                    const statusDot = isFarming 
                        ? '<span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span></span>' 
                        : '<span class="h-3 w-3 rounded-full bg-amber-500"></span>';
                    
                    const toggleBtn = isFarming
                        ? `<button onclick="toggleAction('${acc.tenant_id}', 'pause')" class="text-xs font-semibold bg-amber-100 hover:bg-amber-200 text-amber-700 px-3 py-1.5 rounded-lg transition-colors shadow-sm">‚è∏ D·ª´ng</button>`
                        : `<button onclick="toggleAction('${acc.tenant_id}', 'play')" class="text-xs font-semibold bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-3 py-1.5 rounded-lg transition-colors shadow-sm">‚ñ∂ Ti·∫øp t·ª•c</button>`;

                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-3.5 bg-white/70 rounded-xl border border-white shadow-sm hover:shadow-md transition';
                    el.innerHTML = `
                        <div class="flex items-center gap-3 w-full">
                            ${statusDot}
                            <div class="flex-1">
                                <p class="font-bold text-slate-800 text-sm">${acc.identifier}</p>
                                <div class="flex items-center gap-2 mt-1 flex-wrap">
                                    <span class="text-[11px] text-slate-500 font-mono bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">ID: ${acc.tenant_id.substring(0,8)}</span>
                                    <span class="text-xs font-bold text-sky-700 bg-sky-100 px-2 py-0.5 rounded border border-sky-200 shadow-sm">Bal: ${balanceText}</span>
                                    ${autoTxBadge}
                                </div>
                            </div>
                            <div class="flex gap-2 ml-2">
                                ${toggleBtn}
                                <button onclick="removeAcc('${acc.identifier}')" class="text-xs font-semibold bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1.5 rounded-lg transition-colors shadow-sm">üóë X√≥a</button>
                            </div>
                        </div>
                    `;
                    accList.appendChild(el);

                    const isChecked = checkedTxIds.includes(acc.tenant_id) ? 'checked' : '';
                    const txEl = document.createElement('label');
                    txEl.className = 'flex items-center gap-2 text-sm text-slate-700 cursor-pointer hover:bg-sky-50 p-1 rounded transition';
                    txEl.innerHTML = `
                        <input type="checkbox" class="tx-check" value="${acc.tenant_id}" ${isChecked}>
                        <span class="font-medium truncate flex-1">${acc.identifier}</span>
                    `;
                    txAccList.appendChild(txEl);
                });

                const logBox = document.getElementById('consoleLog');
                const isScrolledToBottom = logBox.scrollHeight - logBox.clientHeight <= logBox.scrollTop + 10;
                
                logBox.innerHTML = data.logs.map(l => {
                    let color = "text-sky-300";
                    if(l.includes("üí∞ Balance")) color = "text-fuchsia-300";
                    if(l.includes("üéâ CHUY·ªÇN TH√ÄNH C√îNG") || l.includes("K√≠ch ho·∫°t AFK")) color = "text-emerald-400 font-bold";
                    if(l.includes("‚ö†Ô∏è") || l.includes("‚è∏")) color = "text-amber-300";
                    if(l.includes("‚ùå")) color = "text-red-400";
                    return `<div class="${color}">${l}</div>`;
                }).join('');
                
                if (data.logs.length === 0) logBox.innerHTML = '<div class="text-slate-500">[H·ªá Th·ªëng] Tr·ªëng.</div>';
                if (isScrolledToBottom) logBox.scrollTop = logBox.scrollHeight;

            } catch (e) {
                console.error(e);
            }
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.tx-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        async function applyAutoTransfer(enabled) {
            const selectedIds = Array.from(document.querySelectorAll('.tx-check')).filter(cb => cb.checked).map(cb => cb.value);
            if (selectedIds.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 t√†i kho·∫£n ƒë·ªÉ √°p d·ª•ng!");
            
            const threshold = document.getElementById('txThreshold').value;
            const target = document.getElementById('txTarget').value;
            
            if (enabled && (!threshold || !target)) {
                return alert("Vui l√≤ng nh·∫≠p M·ªëc Balance v√† T√™n ng∆∞·ªùi nh·∫≠n!");
            }

            // L∆ØU C·∫§U H√åNH V√ÄO LOCALSTORAGE TR√åNH DUY·ªÜT ƒê·ªÇ L·∫¶N SAU KH√îNG C·∫¶N G√ï L·∫†I
            localStorage.setItem('altare_tx_threshold', threshold);
            localStorage.setItem('altare_tx_target', target);

            try {
                await fetch('/api/auto_transfer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        client_id: CLIENT_ID,
                        tenant_ids: selectedIds,
                        threshold: parseFloat(threshold || 0),
                        target: target,
                        enabled: enabled
                    })
                });
                alert(enabled ? "ƒê√£ B·∫¨T Auto Chuy·ªÉn Credit th√†nh c√¥ng!" : "ƒê√£ T·∫ÆT Auto Chuy·ªÉn Credit!");
                fetchState();
            } catch(e) {
                alert("C√≥ l·ªói x·∫£y ra khi l∆∞u c·∫•u h√¨nh.");
            }
        }

        async function clearLogs() {
            await fetch('/api/clear_logs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ client_id: CLIENT_ID })
            });
            fetchState();
        }

        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(isProxy) return alert("B·ªã ch·∫∑n do Proxy.");
            const btn = document.getElementById('addBtn');
            const msg = document.getElementById('addMsg');
            btn.innerText = "ƒêang k·∫øt n·ªëi..."; btn.disabled = true;

            try {
                const res = await fetch('/api/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        client_id: CLIENT_ID,
                        identifier: document.getElementById('identifier').value,
                        password: document.getElementById('password').value
                    })
                });
                const result = await res.json();
                msg.classList.remove('hidden');
                if(result.success) {
                    msg.className = "mt-3 text-sm text-center text-emerald-600 font-bold";
                    msg.innerText = "Th√™m th√†nh c√¥ng!";
                    document.getElementById('addForm').reset();
                    fetchState();
                } else {
                    msg.className = "mt-3 text-sm text-center text-red-500 font-bold";
                    msg.innerText = result.error || "Th·∫•t b·∫°i.";
                }
            } catch(e) {
                msg.classList.remove('hidden'); msg.innerText = "L·ªói k·∫øt n·ªëi.";
            }
            btn.innerText = "B·∫Øt ƒê·∫ßu Farm"; btn.disabled = false;
        });

        async function toggleAction(tenantId, action) {
            await fetch('/api/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ client_id: CLIENT_ID, tenant_id: tenantId, action: action })
            });
            fetchState();
        }

        async function removeAcc(identifier) {
            if(!confirm(`X√≥a ho√†n to√†n t√†i kho·∫£n ${identifier}?`)) return;
            await fetch('/api/remove', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ client_id: CLIENT_ID, identifier: identifier })
            });
            fetchState();
        }

        runChecks();
        fetchState();
        setInterval(fetchState, 2000);
    </script>
</body>
</html>
"""

@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE)

@app.route('/api/state', methods=['GET'])
def get_state():
    client_id = request.args.get('client_id')
    if not client_id: return jsonify({"accounts": [], "sessions": {}, "logs": []})
    init_client_state(client_id)
    cfg = load_config(client_id)
    return jsonify({
        "accounts": cfg.get("accounts", []),
        "sessions": app_state["sessions"].get(client_id, {}),
        "logs": app_state["logs"].get(client_id, [])
    })

@app.route('/api/toggle', methods=['POST'])
def toggle_account():
    data = request.json
    client_id = data.get("client_id")
    tenant_id = data.get("tenant_id")
    action = data.get("action")
    if not client_id: return jsonify({"success": False})
    
    cfg = load_config(client_id)
    acc = next((a for a in cfg.get("accounts", []) if a["tenant_id"] == tenant_id), None)
    if acc and tenant_id in app_state["sessions"].get(client_id, {}):
        headers = make_headers(acc["token"], tenant_id)
        if action == 'pause':
            app_state["sessions"][client_id][tenant_id]["is_farming"] = False
            stop_afk_session(client_id, headers, tenant_id, acc["identifier"])
        elif action == 'play':
            app_state["sessions"][client_id][tenant_id]["is_farming"] = True
            start_afk_session(client_id, headers, tenant_id, acc["identifier"])
        return jsonify({"success": True})
    return jsonify({"success": False})

@app.route('/api/auto_transfer', methods=['POST'])
def set_auto_transfer():
    data = request.json
    client_id = data.get("client_id")
    tenant_ids = data.get("tenant_ids", [])
    threshold = float(data.get("threshold", 0))
    target = data.get("target", "")
    enabled = data.get("enabled", False)
    
    if not client_id: return jsonify({"success": False})
    
    # 1. C·∫≠p nh·∫≠t v√†o JSON config ƒë·ªÉ L∆ØU Vƒ®NH VI·ªÑN
    cfg = load_config(client_id)
    accounts = cfg.get("accounts", [])
    
    for tid in tenant_ids:
        # C·∫≠p nh·∫≠t app_state (B·ªô nh·ªõ t·∫°m ƒëang ch·∫°y)
        if client_id in app_state["sessions"] and tid in app_state["sessions"][client_id]:
            app_state["sessions"][client_id][tid]["auto_transfer"] = {
                "enabled": enabled,
                "threshold": threshold,
                "target": target
            }
        # C·∫≠p nh·∫≠t Config File (ƒê·ªÉ t·∫£i l·∫°i kh√¥ng m·∫•t)
        for acc in accounts:
            if acc["tenant_id"] == tid:
                acc["auto_transfer"] = {
                    "enabled": enabled,
                    "threshold": threshold,
                    "target": target
                }
                
    cfg["accounts"] = accounts
    save_config(client_id, cfg)
    
    return jsonify({"success": True})

@app.route('/api/clear_logs', methods=['POST'])
def clear_logs():
    client_id = request.json.get("client_id")
    if client_id in app_state["logs"]:
        app_state["logs"][client_id] = []
    return jsonify({"success": True})

@app.route('/api/add', methods=['POST'])
def add_account():
    data = request.json
    client_id = data.get("client_id")
    identifier = data.get("identifier")
    password = data.get("password")
    if not client_id: return jsonify({"success": False, "error": "Thi·∫øu Client ID."})
    
    cfg = load_config(client_id)
    accounts = cfg.get("accounts", [])
    if len(accounts) >= 4: return jsonify({"success": False, "error": "ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 4 t√†i kho·∫£n."})
    for acc in accounts:
        if acc["identifier"] == identifier: return jsonify({"success": False, "error": "T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i."})

    url_login = 'https://api.altare.sh/api/auth/login'
    url_tenants = 'https://api.altare.sh/api/tenants'
    headers = make_headers("")
    
    try:
        res = requests.post(url_login, headers=headers, json={"identifier": identifier, "password": password})
        if res.status_code == 200:
            token = f"Bearer {res.json().get('token')}"
            h_tenant = make_headers(token)
            t_res = requests.get(url_tenants, headers=h_tenant)
            tenant_id = ""
            if t_res.status_code == 200 and t_res.json().get("items"):
                tenant_id = t_res.json()["items"][0].get("id")
            if not tenant_id: return jsonify({"success": False, "error": "L·ªói Tenant ID."})
            
            new_acc = {"identifier": identifier, "token": token, "tenant_id": tenant_id}
            accounts.append(new_acc)
            cfg["accounts"] = accounts
            save_config(client_id, cfg)
            start_account_threads(client_id, cfg, new_acc)
            return jsonify({"success": True})
        else:
            return jsonify({"success": False, "error": "Sai th√¥ng tin ƒëƒÉng nh·∫≠p."})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

@app.route('/api/remove', methods=['POST'])
def remove_account():
    data = request.json
    client_id = data.get("client_id")
    identifier = data.get("identifier")
    if not client_id: return jsonify({"success": False})
    
    cfg = load_config(client_id)
    accounts = cfg.get("accounts", [])
    for acc in accounts:
        if acc["identifier"] == identifier:
            stop_account_threads(client_id, acc, remove_completely=True)
            break
    cfg["accounts"] = [a for a in accounts if a["identifier"] != identifier]
    save_config(client_id, cfg)
    return jsonify({"success": True})

if __name__ == "__main__":
    for config_file in glob.glob(os.path.join(CONFIG_DIR, "*.json")):
        client_id = os.path.basename(config_file).replace(".json", "")
        config_data = load_config(client_id)
        for account in config_data.get("accounts", []):
            add_log(client_id, "ƒêang ph·ª•c h·ªìi phi√™n...", account["identifier"])
            start_account_threads(client_id, config_data, account)
            
    print(f"\n{'-'*50}\n[+] Web Server v6.1 (Saved State Edition) S·∫µn S√†ng!\n[+] Truy c·∫≠p: http://0.0.0.0:5000\n{'-'*50}\n")
    import logging
    log = logging.getLogger('werkzeug')
    log.setLevel(logging.ERROR)
    app.run(host="0.0.0.0", port=5000)
ƒêang hi√™Ãân thiÃ£ 688491042888230979.
